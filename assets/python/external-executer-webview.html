<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    textarea { width: 100%; height: 150px; }
    button { margin: 5px; }
    pre { background: #000; color: #0f0; padding: 10px; height: 150px; overflow: auto; }
  </style>
</head>
<body>
  <h3>Python æ¸¬è©¦å™¨</h3>
  <p>å°‡æª”æ¡ˆæ”¾ç½®æ–¼ /sdcard/Documents/robot-core-adv/ å…§ï¼Œæœƒè‡ªå‹•é‹è¡Œ main.py</p>
  <p>packages.txt ç”¨æ–¼å­˜æ”¾æ‰€éœ€çš„packagesï¼Œåœ¨è¼‰å…¥Pythonæ™‚æœƒå…ˆåŠ è¼‰å®Œæˆ (é¡ä¼¼ pip install)ï¼Œæ ¼å¼: æ¯å€‹å¥—ä»¶åç¨±ç”¨æ›è¡Œåˆ†é–‹</p>
  <button onclick="runCode()">åŸ·è¡Œ</button>
  <button onclick="clearLog()">æ¸…é™¤ Log</button>
  <button onclick="reLoad()">é‡æ–°è¼‰å…¥ Kernel</button>
  <pre id="output"></pre>
  <script>
    // å°‡ console.log è½‰é€åˆ° React Native
    const originalLog = console.log;
    console.log = function (...args) {
      originalLog(...args);
      try {
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'CONSOLE_LOG', log: args.join(' ') }));
      } catch (e) {}
    };
  </script>
  <script>
    let pyodide;
    let scriptMap = {};

    function log(msg) {
      const output = document.getElementById('output');
      output.textContent += msg + '\n';
      output.scrollTop = output.scrollHeight;
    }

    function clearLog() {
      document.getElementById('output').textContent = '';
    }

    function reLoad() {
      document.location.reload();
    }

    async function runCode() {
      try {
        log('ğŸš€ Executing main.py...');
        log("--------------------------------------------------");
        await pyodide.runPythonAsync('exec(open("main.py").read())');
        log("--------------------------------------------------");
        log('âœ… Finish Execution');
      } catch (err) {
        log(`âŒ Error: ${err}`);
      }
    }

    async function load_module(name) {
      try {
        await pyodide.loadPackage(name);
        log(`âœ… Loaded ${name}`);
      } catch (err) {
        log(`âŒ Error loading ${name}: ${err}`);
      }
    }

    async function main() {
      log('Loading Pyodide...');
      pyodide = await loadPyodide();
      log('Finish Pyodide setup!');

      // å®šç¾© JS ç«¯å¯ä¾› Python å‘¼å«çš„åŠŸèƒ½
      await pyodide.runPythonAsync(`
        import js
        import builtins
        # è¦†è“‹æ‰€æœ‰ä½œç”¨åŸŸçš„ print
        builtins.print = lambda *args, **kwargs: js.log(" ".join(map(str, args)))
      `);
      log("Loading modules...");
      // å‘ŠçŸ¥ React Nativeï¼šåˆå§‹åŒ–å®Œæˆï¼Œå¯å‚³é€è³‡æ–™
      window.ReactNativeWebView?.postMessage(JSON.stringify({ type: 'PYODIDE_READY' }));
    }

    // æ¥æ”¶ä¾†è‡ª React Native çš„è¨Šæ¯
    document.addEventListener('message', async (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === 'LOAD_SCRIPTS') {
        scriptMap = msg.scripts;
        for (let [name, content] of Object.entries(scriptMap)) {
          console.log(`Loading ${name}...`);
          pyodide.FS.writeFile(name, content);
        }
        // å‡è¨­ä½ æœ‰ä¸€å€‹ main.pyï¼Œç¾åœ¨æ˜ç¢ºåŸ·è¡Œå®ƒï¼š
        if (scriptMap['main.py']) {
          runCode();
        }
      }
      if (msg.type === 'LOAD_PACKAGES') {
        for (const n of msg.packages) {
          log(`Loading ${n}...`);
          await load_module(n);
        }
        window.ReactNativeWebView?.postMessage(JSON.stringify({ type: 'MODULE_LOADED' }));
      }
    });

    main();
  </script>
</body>
</html>